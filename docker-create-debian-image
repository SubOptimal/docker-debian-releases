#!/bin/bash

set -e -o pipefail

usage="Usage: $0 [-h] [-k] [distribution [architecture]]"

keepdir=false

while getopts ":kh" opt; do
    case "$opt" in
        k) keepdir=true;;
        h) echo "$usage"; exit 0;;
        \?) printf "Invalid argument\\n%s\\n" "$usage" >&2; exit 1;;
    esac
done
shift $((OPTIND-1))

dist=${1-jessie}
arch=${2-amd64}

case "$dist" in
    potato)  mirror=http://archive.debian.org/debian;;
    woody)   mirror=http://archive.debian.org/debian;;
    sarge)   mirror=http://archive.debian.org/debian;;
    etch)    mirror=http://archive.debian.org/debian;;
    lenny)   mirror=http://archive.debian.org/debian;;
    squeeze) mirror=http://archive.debian.org/debian;;
    *)       mirror=http://deb.debian.org/debian;;
esac

set -x

name=debian-${dist}-${arch}
dir="root-$name"
image="$USER/$name"
if ! "$keepdir"; then
    trap 'sudo rm -rf "$dir"' EXIT
fi
sudo debootstrap --no-check-gpg "--arch=$arch" "$dist" "$dir" "$mirror"
if [ -d "$dir/var/lib/apt/lists" ]; then
    sudo find "$dir/var/lib/apt/lists" -type f -delete
fi
sudo tar -C "$dir" -c . | docker import - "$image"
docker inspect \
       -f "$image: arch {{.Architecture}}, size {{printf \"%.0f\" .Size}}, id {{.Id}}" \
       "$image"
